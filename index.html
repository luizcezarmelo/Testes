<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Impress√£o em lote</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Estilos Gerais (Tela) */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f6f8; }
        h2 { color: #0056b3; margin-bottom: 10px; }
        
        /* Painel de Controle */
        .painel { 
            background: white; padding: 20px; border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; 
        }
        .linha { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; margin-bottom: 15px; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .checkbox-item { 
            background: #e9ecef; padding: 8px 12px; border-radius: 4px; 
            display: flex; align-items: center; gap: 5px; cursor: pointer;
        }
        .checkbox-item:hover { background: #dee2e6; }
        
        input[type="text"] { padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 200px; }
        
        /* Bot√µes */
        button { 
            padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; 
            font-weight: bold; color: white; transition: 0.2s; font-size: 14px;
        }
        #btn-visualizar { background-color: #17a2b8; }
        #btn-pdf { background-color: #28a745; display: none; } /* Escondido inicialmente */
        #btn-imprimir-browser { background-color: #007bff; display: none; } /* Escondido inicialmente */
        #btn-limpar { background-color: #dc3545; }
        
        /* √Årea de Visualiza√ß√£o na Tela */
        #area-preview { 
            display: flex; flex-direction: column; align-items: center; gap: 20px; 
            padding: 20px; min-height: 100px;
        }
        
        /* Estilos da Folha na TELA (Preview) */
        .folha {
            width: 210mm; height: 297mm; /* A4 */
            background: white; border: 1px solid #ccc;
            display: flex; flex-direction: column; 
            position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            overflow: hidden; /* Corta excessos na visualiza√ß√£o */
        }
        
        /* A imagem deve caber dentro da folha respeitando margem */
        .folha img {
            width: 94%;         /* Deixa 3% de margem nas laterais */
            height: 94%;        /* Deixa 3% de margem no topo/base */
            object-fit: contain; /* Garante que a imagem inteira apare√ßa sem esticar */
            margin: auto;       /* Centraliza */
            display: block;
        }
        
        .referencia {
            position: absolute; top: 15px; right: 20px; 
            background: white; padding: 4px 8px; border: 1px solid black; 
            font-weight: bold; font-size: 14px; z-index: 10;
        }

        /* --- ESTILOS DE IMPRESS√ÉO (CORRE√á√ÉO DO PROBLEMA DA P√ÅGINA EM BRANCO) --- */
        @media print {
            /* 1. Esconde tudo que n√£o √© folha */
            .painel, h2, button, .status-msg { display: none !important; }
            body, html { margin: 0; padding: 0; background: white; height: 100%; }
            #area-preview { margin: 0; padding: 0; display: block; gap: 0; }

            /* 2. Configura a folha para impress√£o */
            .folha {
                border: none; box-shadow: none; margin: 0;
                width: 100%; height: 100vh; /* Ocupa exatamente 1 altura de papel */
                page-break-after: always;   /* Quebra depois de cada folha */
                page-break-inside: avoid;   /* Evita quebrar a imagem no meio */
                display: flex; justify-content: center; align-items: center;
            }

            /* 3. TRUQUE FINAL: Reduz ligeiramente a imagem na impress√£o para n√£o "vazar" */
            .folha img {
                max-width: 95%;  /* Garante margem lateral */
                max-height: 90vh; /* Garante que cabe na altura sem criar folha extra */
            }

            /* Remove a quebra da √∫ltima p√°gina para n√£o imprimir folha vazia no final */
            .folha:last-child { page-break-after: auto; }
        }
    </style>
</head>
<body>

    <h2>üñ®Ô∏è Sistema de Impress√£o</h2>

    <div class="painel">
        <div class="linha">
            <label>Paciente:</label>
            <input type="text" id="texto-referencia" maxlength="40" placeholder="F999999 PACIENTE TESTE 2A">
        </div>
        
        <div class="linha">
            <div class="checkbox-group" id="opcoes-container"></div>
        </div>

        <div class="linha">
            <button id="btn-visualizar" onclick="carregarImagens()">Carregar Imagens</button>
            
            <button id="btn-pdf" onclick="baixarPDF()">Baixar PDF</button>
            
            <button id="btn-imprimir-browser" onclick="window.print()">Imprimir</button>
            
            <button id="btn-limpar" onclick="limpar()">Limpar</button>
        </div>
        <div id="status-msg" style="margin-top:10px; font-weight:bold; color:#444;"></div>
    </div>

    <div id="area-preview"></div>

    <script>
        const { jsPDF } = window.jspdf;
        
        // --- CONFIGURA√á√ÉO ---
        const repoName = 'Testes'; 
        const baseURL = `https://luizcezarmelo.github.io/${repoName}`;
        
        const documentos = [
            { id: '0', nome: 'KIT', isKit: true, pages: 6 }, 
            { id: '1', nome: '1 PLM', isKit: false, pages: 2 },
            { id: '2', nome: '2 PL Intermunicipal', isKit: false, pages: 1 },
            { id: '3', nome: '3 PL Interestadual', isKit: false, pages: 1 },
            { id: '4', nome: '4 ANAC', isKit: false, pages: 1 },
            { id: '5', nome: '5 IPVA', isKit: false, pages: 1 },
            { id: '6', nome: '6 IPI', isKit: false, pages: 1 }
        ];

        // Inicializa Checkboxes
        const container = document.getElementById('opcoes-container');
        documentos.forEach(doc => {
            const div = document.createElement('div');
            div.className = 'checkbox-item';
            div.innerHTML = `<input type="checkbox" id="doc-${doc.id}" value="${doc.id}" ${doc.isKit?'checked':''}> <label for="doc-${doc.id}">${doc.nome}</label>`;
            container.appendChild(div);
        });

        // 1. Carregar Imagens na Tela
        function carregarImagens() {
            const preview = document.getElementById('area-preview');
            const ref = document.getElementById('texto-referencia').value.toUpperCase();
            const status = document.getElementById('status-msg');
            
            preview.innerHTML = '';
            status.innerText = "Carregando...";
            
            const selecionados = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => documentos.find(d => d.id === cb.value));

            if (selecionados.length === 0) { alert("Selecione algo!"); return; }

            let totalImagens = 0;

            selecionados.forEach(doc => {
                for (let i = 1; i <= doc.pages; i++) {
                    totalImagens++;
                    // Cache busting (?t=...) para garantir que carregue a imagem nova
                    const url = `${baseURL}/${doc.id}-${i}.png?t=${Date.now()}`;

                    const divFolha = document.createElement('div');
                    divFolha.className = 'folha';
                    
                    // Refer√™ncia no canto
                    if(ref) {
                        divFolha.innerHTML += `<div class="referencia">REF: ${ref}</div>`;
                    }

                    const img = new Image();
                    img.src = url;
                    img.onload = () => { status.innerText = `Carregado: ${doc.nome} p√°g ${i}`; };
                    img.onerror = () => { 
                        divFolha.innerHTML = `<div style="color:red; padding:20px; text-align:center;">ERRO 404:<br>${doc.id}-${i}.png n√£o encontrado!</div>`; 
                    };
                    
                    divFolha.appendChild(img);
                    preview.appendChild(divFolha);
                }
            });

            status.innerText = `Pronto! ${totalImagens} p√°ginas carregadas. Escolha como imprimir.`;
            document.getElementById('btn-pdf').style.display = 'inline-block';
            document.getElementById('btn-imprimir-browser').style.display = 'inline-block';
        }

        // 2. Gerar PDF (Op√ß√£o A - Recomendada)
        async function baixarPDF() {
            const imgs = document.querySelectorAll('.folha img');
            if(imgs.length === 0) return;

            const doc = new jsPDF('p', 'mm', 'a4');
            const width = 210; 
            const height = 297;

            document.getElementById('status-msg').innerText = "Gerando PDF...";

            for (let i = 0; i < imgs.length; i++) {
                if (i > 0) doc.addPage();
                
                // Adiciona imagem centralizada e com margem para n√£o cortar
                // Usamos 200x280mm para garantir seguran√ßa de margem
                doc.addImage(imgs[i], 'PNG', 5, 5, 200, 287, undefined, 'FAST'); 

                // Adiciona Refer√™ncia no PDF
                const ref = document.getElementById('texto-referencia').value.toUpperCase();
                if(ref) {
                    doc.setFontSize(12);
                    doc.setFillColor(255,255,255);
                    doc.rect(160, 5, 45, 8, 'F');
                    doc.text(ref, 200, 10, { align: 'right' });
                }
            }
            doc.save('Impressao_Documentos.pdf');
            document.getElementById('status-msg').innerText = "PDF Baixado!";
        }

        function limpar() {
            document.getElementById('area-preview').innerHTML = '';
            document.getElementById('texto-referencia').value = '';
            document.getElementById('status-msg').innerText = '';
            document.getElementById('btn-pdf').style.display = 'none';
            document.getElementById('btn-imprimir-browser').style.display = 'none';
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = (cb.value === '0'));
        }
    </script>
</body>
</html>

