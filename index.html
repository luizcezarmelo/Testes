<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fus√£o de M√∫ltiplas Imagens para Impress√£o √önica</title>
    <style>
        /* Estilos do Formul√°rio (mantidos) */
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f9; }
        h2 { color: #0056b3; }
        .linha { display: flex; flex-wrap: wrap; align-items: center; padding: 15px; border: 1px solid #007bff; border-radius: 8px; background-color: #ffffff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .linha label { margin-right: 15px; font-weight: bold; color: #333; }
        .checkbox-group { display: flex; flex-wrap: wrap; margin-left: 20px; gap: 15px; }
        input[type="text"] { width: 150px; max-length: 15; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .botoes { margin-top: 20px; }
        .botoes button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px; font-weight: bold; transition: background-color 0.3s; }
        #btn-imprimir { background-color: #28a745; color: white; }
        #btn-imprimir:hover { background-color: #1e7e34; }
        #btn-limpar { background-color: #dc3545; color: white; }
        #btn-limpar:hover { background-color: #c82333; }
        #mensagem-status { margin-top: 10px; color: #ff0000; font-weight: bold; }

        /* Estilos de Impress√£o (CORRIGIDO) */
        @media print {
            .interface-container, .botoes, h2, #mensagem-status { display: none !important; }
            html, body {
                width: 100%;
                margin: 0 !important;
                padding: 0 !important;
            }
            #conteudo-impressao { 
                display: block !important; 
                position: relative !important;
                width: 100% !important;
            }
            /* AQUI EST√Å A CORRE√á√ÉO: Removemos o 'page-break-after' */
            /* e usamos 'page-break-before' APENAS a partir do segundo elemento. */
            .documento-separador:not(:first-child) {
                page-break-before: always !important; /* For√ßa a quebra */
                page-break-inside: avoid !important;  /* Evita quebras desnecess√°rias */
                margin: 0; 
                padding: 0;
            }
            
            /* Esta regra agora √© desnecess√°ria, mas a mantemos limpa */
            .documento-separador:last-child {
                page-break-after: auto;
            }
            
            .documento-separador img {
                width: 100%; 
                height: auto;
                display: block; 
            }
        }
        
        /* Oculta o conte√∫do de impress√£o na tela */
        #conteudo-impressao { display: none; }
    </style>
</head>
<body>

    <h2>üñºÔ∏è Prepara√ß√£o para Impress√£o √önica (Fus√£o de Imagens)</h2>

    <div class="interface-container">
        <div class="linha">
            <label>Refer√™ncia (m√°x. 15 caracteres):</label>
            <input type="text" id="texto-referencia" maxlength="15" placeholder="Digite a refer√™ncia">
            
            <div class="checkbox-group" id="opcoes-pdf">
                </div>
        </div>
    </div>

    <div class="botoes">
        <button id="btn-imprimir" onclick="iniciarImpressao()">Imprimir (Fus√£o √önica)</button>
        <button id="btn-limpar" onclick="limpar()">Limpar</button>
    </div>

    <div id="mensagem-status"></div>

    <div id="conteudo-impressao">
        </div>

    <script>
        // Contagens que resultam em 13 p√°ginas
        const opcoesPDF = [
            { id: '0', nome: 'KIT', isKit: true, pages: 6 },      
            { id: '1', nome: '1 PLM', isKit: false, pages: 2 },    
            { id: '2', nome: '2 P Intermunicipal', isKit: false, pages: 1 }, 
            { id: '3', nome: '3 P Interestadual', isKit: false, pages: 1 },
            { id: '4', nome: '4 ANAC', isKit: false, pages: 1 },
            { id: '5', nome: '5 IPVA', isKit: false, pages: 1 },
            { id: '6', nome: '6 IPI', isKit: false, pages: 1 }
        ];
        
        // Nome do reposit√≥rio no GitHub
        const repoName = 'Testes'; 
        const baseURL = `https://luizcezarmelo.github.io/${repoName}`;

        function criarOpcoes() {
            const container = document.getElementById('opcoes-pdf');
            opcoesPDF.forEach(opcao => {
                const div = document.createElement('div');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'selecao-pdf';
                checkbox.value = opcao.id;
                checkbox.id = `pdf-opcao-${opcao.id}`;
                if (opcao.isKit) checkbox.checked = true;

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = opcao.nome;
                
                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        async function iniciarImpressao() {
            const statusDiv = document.getElementById('mensagem-status');
            const conteudoImpressao = document.getElementById('conteudo-impressao');
            const inputTexto = document.getElementById('texto-referencia').value.trim();
            const checkboxes = document.querySelectorAll('input[name="selecao-pdf"]:checked');
            
            conteudoImpressao.innerHTML = ''; 
            statusDiv.textContent = 'Preparando imagens para impress√£o...';

            if (checkboxes.length === 0) {
                statusDiv.textContent = "Selecione pelo menos um documento.";
                return;
            }
            
            const documentosSelecionados = Array.from(checkboxes).map(cb => {
                return opcoesPDF.find(doc => doc.id === cb.value);
            });
            
            let htmlParaImpressao = '';
            const headerContent = `<div style="text-align: right; padding: 10px; margin: 0; border-bottom: 1px solid #ccc;">`
                + `<p style="margin:0; font-size:12px;">Refer√™ncia: **${inputTexto || 'SEM REFER√äNCIA'}**</p></div>`;

            try {
                documentosSelecionados.forEach(doc => {
                    for (let page = 1; page <= doc.pages; page++) {
                        const imageUrl = `${baseURL}/${doc.id}-${page}.png`; 
                        
                        htmlParaImpressao += `<div class="documento-separador">`;
                        htmlParaImpressao += headerContent; 
                        htmlParaImpressao += `<img src="${imageUrl}" alt="Documento ${doc.id} P√°gina ${page}">`;
                        htmlParaImpressao += `</div>`;
                    }
                });

                conteudoImpressao.innerHTML = htmlParaImpressao;
                statusDiv.textContent = 'Imagens carregadas. Abrindo janela de impress√£o...';
                
                // For√ßa a atualiza√ß√£o do DOM antes de imprimir
                await new Promise(resolve => setTimeout(resolve, 50)); 
                
                window.print();
                statusDiv.textContent = 'Impress√£o enviada.';

            } catch (error) {
                statusDiv.textContent = `ERRO FATAL: ${error.message}.`;
            }
        }

        function limpar() {
            document.getElementById('texto-referencia').value = '';
            document.getElementById('mensagem-status').textContent = '';
            document.getElementById('conteudo-impressao').innerHTML = ''; 
            
            const checkboxes = document.querySelectorAll('input[name="selecao-pdf"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.value === '0') {
                    checkbox.checked = true; 
                } else {
                    checkbox.checked = false; 
                }
            });
        }

        // Inicializar a aplica√ß√£o
        criarOpcoes();
    </script>
</body>
</html>
