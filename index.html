<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de PDF Unificado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f7f9; }
        h2 { color: #0056b3; }
        .linha { 
            display: flex; flex-wrap: wrap; align-items: center; padding: 15px; 
            border: 1px solid #007bff; border-radius: 8px; background-color: #ffffff; 
        }
        .linha label { margin-right: 15px; font-weight: bold; color: #333; }
        .checkbox-group { display: flex; flex-wrap: wrap; margin-left: 20px; gap: 15px; }
        input[type="text"] { width: 150px; max-length: 15; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .botoes { margin-top: 20px; }
        button { 
            padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; 
            margin-right: 10px; font-weight: bold; color: white; font-size: 16px;
        }
        #btn-gerar { background-color: #007bff; }
        #btn-gerar:hover { background-color: #0056b3; }
        #btn-limpar { background-color: #dc3545; }
        #mensagem-status { margin-top: 15px; font-weight: bold; color: #333; padding: 10px; background: #e9ecef; display: none; border-radius: 4px;}
    </style>
</head>
<body>

    <h2>üñ®Ô∏è Gerador de Arquivo de Impress√£o</h2>
    <p>Selecione os documentos. O sistema ir√° baixar as imagens e criar um √∫nico arquivo PDF para voc√™.</p>

    <div class="linha">
        <label>Refer√™ncia (Top Dir.):</label>
        <input type="text" id="texto-referencia" maxlength="15" placeholder="Ex: CLIENTE-01">
        
        <div class="checkbox-group" id="opcoes-pdf">
            </div>
    </div>

    <div class="botoes">
        <button id="btn-gerar" onclick="gerarPDF()">Baixar PDF para Imprimir</button>
        <button id="btn-limpar" onclick="limpar()">Limpar</button>
    </div>

    <div id="mensagem-status"></div>

    <script>
        const { jsPDF } = window.jspdf;

        // CONFIGURA√á√ÉO: NOME DO REPOSIT√ìRIO E P√ÅGINAS
        const repoName = 'Testes'; 
        const baseURL = `https://luizcezarmelo.github.io/${repoName}`;

        const opcoesPDF = [
            { id: '0', nome: 'KIT', isKit: true, pages: 6 },      
            { id: '1', nome: '1 PLM', isKit: false, pages: 2 },    
            { id: '2', nome: '2 P Intermunicipal', isKit: false, pages: 1 }, 
            { id: '3', nome: '3 P Interestadual', isKit: false, pages: 1 },
            { id: '4', nome: '4 ANAC', isKit: false, pages: 1 },
            { id: '5', nome: '5 IPVA', isKit: false, pages: 1 },
            { id: '6', nome: '6 IPI', isKit: false, pages: 1 }
        ];

        function criarOpcoes() {
            const container = document.getElementById('opcoes-pdf');
            opcoesPDF.forEach(opcao => {
                const div = document.createElement('div');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.name = 'selecao-pdf';
                checkbox.value = opcao.id;
                checkbox.id = `opt-${opcao.id}`;
                if (opcao.isKit) checkbox.checked = true;

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = opcao.nome;
                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        function showStatus(msg, cor = '#333') {
            const el = document.getElementById('mensagem-status');
            el.style.display = 'block';
            el.style.color = cor;
            el.innerText = msg;
        }

        // Fun√ß√£o auxiliar para carregar imagem e garantir que ela existe
        function carregarImagem(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = "Anonymous"; // Necess√°rio para usar no PDF
                // Adiciona timestamp para evitar CACHE VELHO (Resolve o problema de ver arquivo antigo)
                img.src = url + '?v=' + new Date().getTime(); 
                
                img.onload = () => resolve(img);
                img.onerror = () => reject(url);
            });
        }

        async function gerarPDF() {
            const inputTexto = document.getElementById('texto-referencia').value.trim() || "";
            const checkboxes = document.querySelectorAll('input[name="selecao-pdf"]:checked');

            if (checkboxes.length === 0) {
                alert("Selecione pelo menos um item.");
                return;
            }

            showStatus("‚è≥ Baixando imagens e gerando PDF... Aguarde.");

            // Cria um PDF tamanho A4 (unidade mm)
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const pdfWidth = 210;
            const pdfHeight = 297;

            let paginaAtual = 0;

            try {
                // Mapeia os documentos selecionados
                const docsSelecionados = Array.from(checkboxes).map(cb => opcoesPDF.find(o => o.id === cb.value));

                for (const documento of docsSelecionados) {
                    for (let i = 1; i <= documento.pages; i++) {
                        
                        // Se n√£o for a primeira p√°gina absoluta, adiciona uma nova folha no PDF
                        if (paginaAtual > 0) {
                            doc.addPage();
                        }

                        // Monta URL: 0-1.png, 0-2.png...
                        const urlImg = `${baseURL}/${documento.id}-${i}.png`;

                        // Espera a imagem carregar
                        const imgElement = await carregarImagem(urlImg);

                        // Adiciona a imagem ao PDF (esticando para caber na A4)
                        doc.addImage(imgElement, 'PNG', 0, 0, pdfWidth, pdfHeight);

                        // Adiciona o Texto de Refer√™ncia no canto superior direito
                        if (inputTexto) {
                            doc.setFontSize(12);
                            doc.setTextColor(0, 0, 0); // Preto
                            // Fundo branco para o texto ficar leg√≠vel
                            doc.setFillColor(255, 255, 255);
                            doc.rect(150, 5, 50, 10, 'F'); // Caixa branca
                            doc.text(`Ref: ${inputTexto}`, 195, 12, { align: 'right' });
                        }

                        paginaAtual++;
                    }
                }

                // Salva o arquivo final
                doc.save(`Impressao_${inputTexto || 'Documentos'}.pdf`);
                showStatus("‚úÖ PDF Gerado com sucesso! Verifique seus downloads.", "green");

            } catch (erroUrl) {
                console.error(erroUrl);
                showStatus(`‚ùå ERRO: N√£o foi poss√≠vel encontrar a imagem: ${erroUrl}.\nVerifique se o arquivo existe no GitHub com nome min√∫sculo e extens√£o .png`, "red");
            }
        }

        function limpar() {
            document.getElementById('texto-referencia').value = '';
            document.getElementById('mensagem-status').style.display = 'none';
            const checkboxes = document.querySelectorAll('input[name="selecao-pdf"]');
            checkboxes.forEach(cb => cb.checked = (cb.value === '0'));
        }

        criarOpcoes();
    </script>
</body>
</html>
