<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GCRC</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Estilos Gerais (Tela) */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background-color: #eef1f5; color: #333; }
        h2 { color: #0056b3; margin-bottom: 20px; border-bottom: 2px solid #0056b320; padding-bottom: 5px; }
        
        /* Painel de Controle */
        .painel { 
            background: white; padding: 25px; border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 30px; 
        }
        .linha { display: flex; flex-wrap: wrap; gap: 20px; align-items: center; margin-bottom: 20px; }
        
        .checkbox-group { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px; 
            width: 100%;
        }
        .checkbox-item { 
            background: #f1f4f8; padding: 10px 15px; border-radius: 6px; 
            display: flex; align-items: center; gap: 8px; cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            border: 1px solid #ddd;
        }
        .checkbox-item:hover { background: #e0e6ec; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
        .checkbox-item input[type="checkbox"] { transform: scale(1.2); }
        
        label { font-weight: 500; }

        input[type="text"] { 
            padding: 12px; border: 1px solid #ccc; border-radius: 6px; 
            width: 250px;
            box-sizing: border-box; 
        }
        
        /* Linha de Bot√µes */
        .botoes-linha {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        button { 
            padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; 
            font-weight: bold; color: white; transition: background-color 0.2s, transform 0.1s; 
            font-size: 14px;
            flex-grow: 1;
            min-width: 150px;
        }
        button:hover { transform: translateY(-1px); }

        #btn-visualizar { background-color: #007bff; }
        #btn-pdf { background-color: #28a745; }
        #btn-imprimir-browser { background-color: #17a2b8; }
        #btn-limpar { background-color: #dc3545; }
        
        /* √Årea de Visualiza√ß√£o na Tela */
        #area-preview { 
            display: flex; flex-direction: column; align-items: center; gap: 30px; 
            padding: 20px; min-height: 100px;
        }
        
        /* Estilos da Folha na TELA (Preview) */
        .folha {
            width: 210mm; height: 297mm; /* A4 */
            background: white; border: 1px solid #ddd;
            display: flex; flex-direction: column; 
            position: relative; box-shadow: 0 8px 15px rgba(0,0,0,0.15);
            overflow: hidden;
            margin: 0;
        }
        
        .folha img {
            width: 94%;
            height: 94%;
            object-fit: contain;
            margin: auto;
            display: block;
        }
        
        .referencia {
            position: absolute; top: 15px; right: 20px; 
            background: white; padding: 4px 8px; border: 1px solid #333; 
            font-weight: bold; font-size: 14px; z-index: 10;
        }

        /* --- ESTILOS DE IMPRESS√ÉO --- */
        @media print {
            .painel, h2, .botoes-linha, .status-msg { display: none !important; }
            body, html { margin: 0; padding: 0; background: white; height: 100%; }
            #area-preview { margin: 0; padding: 0; display: block; gap: 0; }

            .folha {
                border: none; box-shadow: none; margin: 0;
                width: 100%; height: 100vh;
                page-break-after: always;
                page-break-inside: avoid;
                display: flex; justify-content: center; align-items: center;
            }

            .folha img {
                max-width: 95%;
                max-height: 90vh;
            }

            .folha:last-child { page-break-after: auto; }
        }
    </style>
</head>
<body>

    <h2>üñ®Ô∏è Sistema de Impress√£o</h2>
    
    <div class="painel">
        <div class="linha">
            <label for="texto-referencia">Paciente:</label>
            <input type="text" id="texto-referencia" maxlength="60" placeholder="Ex: F999999 PACIENTE TESTE 2A">
        </div>
        
        <h3>Documentos Dispon√≠veis:</h3>
        <div class="checkbox-group" id="opcoes-container"></div>
        
        <div class="linha botoes-linha">
            <button id="btn-visualizar" onclick="carregarImagens(false)">Exibir</button>
            
            <button id="btn-pdf" onclick="baixarPDF()">Baixar</button>
            
            <button id="btn-imprimir-browser" onclick="carregarImagens(true)">Imprimir</button>
            
            <button id="btn-limpar" onclick="limpar()">Limpar</button>
        </div>
        <div id="status-msg" style="margin-top:10px; font-weight:bold; color:#0056b3;"></div>
    </div>

    <div id="area-preview"></div>

    <script>
        const { jsPDF } = window.jspdf;
        
        // --- CONFIGURA√á√ÉO DE URLS ---
        const REPO_NAME = 'Testes';
        const BASE_URL_ONLINE = `https://luizcezarmelo.github.io/${REPO_NAME}/`; 
        const BASE_URL_LOCAL = './'; 
        // ---------------------------
        
        const documentos = [
            { id: '0', nome: 'KIT', isKit: true, pages: 6 }, 
            { id: '1', nome: '1 PL Municipal', isKit: false, pages: 2 },
            { id: '2', nome: '2 PL Intermunicipal', isKit: false, pages: 1 },
            { id: '3', nome: '3 PL Interestadual', isKit: false, pages: 1 },
            { id: '4', nome: '4 ANAC', isKit: false, pages: 1 },
            { id: '5', nome: '5 IPVA', isKit: false, pages: 1 },
            { id: '6', nome: '6 IPI', isKit: false, pages: 1 },
            { id: '7', nome: '7 DPVAT', isKit: false, pages: 1 }
        ];

        // Inicializa Checkboxes
        const container = document.getElementById('opcoes-container');
        documentos.forEach(doc => {
            const div = document.createElement('div');
            div.className = 'checkbox-item';
            div.innerHTML = `<input type="checkbox" id="doc-${doc.id}" value="${doc.id}" ${doc.isKit?'checked':''}> <label for="doc-${doc.id}">${doc.nome}</label>`;
            container.appendChild(div);
        });

        // 1. Carregar Imagens na Tela
        // Par√¢metro "imprimirAutomaticamente": se for true, abre a impress√£o ao terminar de carregar tudo
        function carregarImagens(imprimirAutomaticamente = false) {
            const preview = document.getElementById('area-preview');
            const ref = document.getElementById('texto-referencia').value.toUpperCase();
            const status = document.getElementById('status-msg');
            
            preview.innerHTML = '';
            status.innerText = "Iniciando carregamento...";
            
            const selecionados = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => documentos.find(d => d.id === cb.value));

            if (selecionados.length === 0) { 
                status.innerText = "Selecione pelo menos um documento.";
                return; 
            }

            // C√°lculo do total de imagens para controlar quando terminar
            let totalParaCarregar = 0;
            selecionados.forEach(d => totalParaCarregar += d.pages);
            let imagensCarregadasCount = 0;

            // Fun√ß√£o interna para checar se acabou o carregamento
            function verificarTermino() {
                imagensCarregadasCount++;
                status.innerText = `Carregando... (${imagensCarregadasCount} de ${totalParaCarregar})`;
                
                if (imagensCarregadasCount === totalParaCarregar) {
                    status.innerText = "Pronto! Todas as p√°ginas carregadas.";
                    if (imprimirAutomaticamente) {
                        // Pequeno atraso para garantir que o navegador renderizou
                        setTimeout(() => {
                            window.print();
                        }, 500);
                    }
                }
            }

            selecionados.forEach(doc => {
                for (let i = 1; i <= doc.pages; i++) {
                    
                    let filename = `${doc.id}-${i}.png`;
                    
                    // --- L√ìGICA DE CARREGAMENTO COM FALLBACK ---
                    let url_principal = `${BASE_URL_ONLINE}${filename}?t=${Date.now()}`;
                    let url_fallback = `${BASE_URL_LOCAL}${filename}`; 

                    const divFolha = document.createElement('div');
                    divFolha.className = 'folha';
                    
                    if(ref) {
                        divFolha.innerHTML += `<div class="referencia">Paciente: ${ref}</div>`;
                    }

                    const img = new Image();
                    img.src = url_principal; 
                    
                    // Sucesso no carregamento principal
                    img.onload = () => { 
                        verificarTermino();
                    };

                    // Erro no carregamento principal -> Tenta fallback
                    img.onerror = () => { 
                        if (doc.id === '7' || window.location.protocol === 'file:') {
                            img.src = url_fallback; 
                            
                            img.onload = () => verificarTermino();

                            img.onerror = () => {
                                divFolha.innerHTML = `<div style="color:red; padding:20px; text-align:center;">
                                    **ERRO 404:**<br>Arquivo ${filename} n√£o encontrado.
                                </div>`; 
                                status.innerText = `Erro no arquivo: ${filename}`;
                                verificarTermino(); // Conta como carregado (com erro) para n√£o travar
                            };
                        } else {
                            divFolha.innerHTML = `<div style="color:red; padding:20px; text-align:center;">
                                **ERRO 404:**<br>Arquivo ${filename} n√£o encontrado no servidor.
                            </div>`; 
                            status.innerText = `Erro no arquivo: ${filename}`;
                            verificarTermino(); // Conta como carregado (com erro) para n√£o travar
                        }
                    };
                    
                    divFolha.appendChild(img);
                    preview.appendChild(divFolha);
                }
            });
        }

        // 2. Gerar PDF
        async function baixarPDF() {
            const imgs = document.querySelectorAll('.folha img');
            if(imgs.length === 0) {
                alert("Por favor, clique em 'Exibir' para carregar os documentos antes de baixar.");
                return;
            }

            const doc = new jsPDF('p', 'mm', 'a4');
            document.getElementById('status-msg').innerText = "Gerando PDF...";

            for (let i = 0; i < imgs.length; i++) {
                if (!imgs[i].complete || imgs[i].naturalHeight === 0) continue; 

                if (i > 0) doc.addPage();
                
                doc.addImage(imgs[i], 'PNG', 5, 5, 200, 287, undefined, 'FAST'); 

                const ref = document.getElementById('texto-referencia').value.toUpperCase();
                if(ref) {
                    doc.setFontSize(12);
                    doc.setFillColor(255,255,255);
                    doc.rect(160, 5, 45, 8, 'F');
                    doc.text(ref, 200, 10, { align: 'right' });
                }
            }
            doc.save('Impressao_Documentos.pdf');
            document.getElementById('status-msg').innerText = "PDF Baixado!";
        }

        function limpar() {
            document.getElementById('area-preview').innerHTML = '';
            document.getElementById('texto-referencia').value = '';
            document.getElementById('status-msg').innerText = '';
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = (cb.value === '0'));
        }
    </script>
</body>
</html>
